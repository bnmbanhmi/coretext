# ATDD Checklist - Epic 2: Agent Context Retrieval & Semantic Querying

**Date:** 2025-12-26
**Author:** Minh (TEA Agent)
**Primary Test Level:** Integration (API/MCP)

---

## Story Summary

Epic 2 enables AI agents to query the coretext knowledge graph via an MCP server. This provides the "Topology Awareness" required for high-precision code generation by allowing agents to retrieve relevant document nodes and traverse dependencies.

---

## Acceptance Criteria

1. **FR9**: MCP Server Setup & Health Check (Story 2.1)
2. **FR10**: Semantic Tool for Topology Search (Story 2.2)
3. **FR11**: Semantic Tool for Dependency Retrieval (Story 2.3)
4. **FR12**: Traverse graph relationships (Story 2.3)
5. **FR22**: Response within 500ms (NFR)

---

## Failing Tests Created (RED Phase)

### Integration Tests (3 files)

**File:** `tests/integration/server/test_story_2_1.py`
- ✅ **Test:** `test_health_check_returns_200`
  - **Status:** RED - `ModuleNotFoundError: No module named 'coretext.server.app'`
  - **Verifies:** Daemon starts and responds to `/health`.
- ✅ **Test:** `test_server_binds_only_to_localhost`
  - **Status:** RED - `ModuleNotFoundError`
  - **Verifies:** Security constraint (127.0.0.1 binding).

**File:** `tests/integration/server/test_story_2_2.py`
- ✅ **Test:** `test_search_topology_returns_relevant_nodes`
  - **Status:** RED - `ModuleNotFoundError`
  - **Verifies:** Vector similarity search returns graph nodes.

**File:** `tests/integration/server/test_story_2_3.py`
- ✅ **Test:** `test_get_dependencies_returns_tree`
  - **Status:** RED - `ModuleNotFoundError`
  - **Verifies:** Graph relationship traversal (`depends_on`, `PARENT_OF`).

---

## Implementation Checklist

### Story 2.1: MCP Server Setup & Health Check

- [ ] Create `coretext/server/app.py` with FastAPI.
- [ ] Implement `GET /health` endpoint returning `{"status": "ok"}`.
- [ ] Configure `uvicorn` to bind strictly to `127.0.0.1`.
- [ ] Run test: `pytest tests/integration/server/test_story_2_1.py`
- [ ] ✅ Test passes (green phase)

### Story 2.2: Semantic Tool for Topology Search

- [ ] Implement `coretext/core/vector/embedder.py` using `nomic-embed-text-v1.5`.
- [ ] Implement `POST /mcp/tools/search_topology` in `coretext/server/mcp/routes.py`.
- [ ] Integrate with `GraphManager` to perform SurrealQL vector search.
- [ ] Run test: `pytest tests/integration/server/test_story_2_2.py`
- [ ] ✅ Test passes (green phase)

### Story 2.3: Semantic Tool for Dependency Retrieval

- [ ] Implement `POST /mcp/tools/get_dependencies` in `coretext/server/mcp/routes.py`.
- [ ] Add relationship traversal logic to `GraphManager`.
- [ ] Run test: `pytest tests/integration/server/test_integration/server/test_story_2_3.py`
- [ ] ✅ Test passes (green phase)

---

## Running Tests

```bash
# Run all failing tests for Epic 2
pytest tests/integration/server/

# Run with verbose output
pytest -v tests/integration/server/
```

---

## Red-Green-Refactor Workflow

### RED Phase (Complete) ✅

- ✅ Failing integration tests created for Story 2.1, 2.2, and 2.3.
- ✅ Tests fail due to missing server implementation.

---

### GREEN Phase (Next Steps)

1. **Pick Story 2.1**: Implement the FastAPI scaffold and health check.
2. **Verify Story 2.1**: Run `pytest tests/integration/server/test_story_2_1.py`.
3. **Pick Story 2.2**: Implement embedding and vector search.
4. **Move to next story** until all are green.

---

## Test Execution Evidence

### Initial Test Run (RED Phase Verification)

**Command:** `pytest tests/integration/server/`

**Status:** ✅ RED phase verified (ModuleNotFoundError)

---

**Generated by BMad TEA Agent** - 2025-12-26
