@startuml Coretext_GraphDataModel

' --- UI Configuration ---
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontName "Helvetica Neue, Arial, sans-serif"
skinparam class {
    BackgroundColor White
    ArrowColor Black
    BorderColor Black
}

' --- Node Type Definitions (Entities) ---

' Base Node, everything in SurrealDB inherits from here
abstract class "BaseNode\n<<SurrealDB Record>>" as BaseNode {
    + id: string {PK} (Relative File Path. E.g.: docs/epics/login.md)
    + created_at: datetime
    + updated_at: datetime
    + content_hash: string (Merkle hash for sync)
}

' Node containing Vector Embedding (for Semantic Search)
abstract class "VectorizedNode\n<<MRL Embedding>>" as VectorizedNode {
    + embedding: vector<float, 768> (Nomic Embed v1.5)
    + plain_text: string (Raw content for lexical search)
}

' FileNode: Represents a physical file on disk
class "FileNode\n(Original Markdown File)" as FileNode {
    + file_type: string (E.g.: 'bm_epic', 'bm_story', 'code')
    + git_commit: string
}

' SectionNode: Represents a small segment in a file (Chunking by Header)
class "SectionNode\n(Section by Header)" as SectionNode {
    + header_level: int (H1, H2, H3)
    + title: string
    + anchor_id: string (E.g.: file.md#header-title)
}

' Specific BMAD Nodes (Projection from Markdown)
class "EpicNode\n<<BMAD>>" as Epic {
    + status: string
    + target_date: date
}

class "StoryNode\n<<BMAD>>" as Story {
    + status: string
    + points: int
    + acceptance_criteria: list<string>
}

' --- Inheritance Relationships ---
BaseNode <|-- VectorizedNode
VectorizedNode <|-- FileNode
VectorizedNode <|-- SectionNode

FileNode <|-- Epic
FileNode <|-- Story

' --- Edge Type Definitions (Edges/Relationships) ---

' Internal file structure (Structural Edges)
FileNode "1" *-- "many" SectionNode : <<CONTAINS>>\n(File contains sections) >
SectionNode "1" *-- "many" SectionNode : <<PARENT_OF>>\n(H1 contains H2) >

' Semantic relationships between files (Semantic Edges - The "Brain")
' Created when parser encounters link like: [Label](./path/to/another_file.md)

Epic "1" --> "many" Story : <<DECOMPOSED_INTO>>\n(Link in Children Stories section) >
Story "many" --> "1" Epic : <<BELONGS_TO>>\n(Link in Header metadata) >

Story "many" --> "many" Story : <<DEPENDS_ON>>\n(Link in Dependencies metadata) >
BaseNode "many" ..> "many" BaseNode : <<REFERENCES>>\n(Any link in text content) >


note right of BaseNode
  <b>Core Principle:</b>
  Node ID is always the relative <b>File Path</b>.
  This ensures 1-1 mapping between
  Git and Database.
end note

note bottom of SectionNode
  <b>Chunking Strategy:</b>
  Instead of splitting by word count, we split
  by Header structure (H1, H2...).
  Each Header becomes a child node
  to preserve semantic integrity.
end note

@enduml